name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.0, v2.1.0, etc.
      - 'v*.*'    # Also supports v1.0 format

permissions:
  contents: write  # Required to create releases

jobs:
  build-and-release:
    runs-on: windows-latest
    
    strategy:
      matrix:
        configuration: [Debug, Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Install Windows SDK with Debugging Tools
      shell: powershell
      run: |
        Write-Host "Setting up Windows SDK and Debugging Tools..."
        
        # First, check what's already available
        Write-Host "Checking pre-installed SDKs..."
        $kitsPath = "C:\Program Files (x86)\Windows Kits\10\Include"
        if (Test-Path $kitsPath) {
          Get-ChildItem $kitsPath | ForEach-Object { Write-Host "  - $($_.Name)" }
        }
        
        # Check for Debugging Tools
        $debuggerFound = $false
        $searchPaths = @(
          "C:\Program Files (x86)\Windows Kits\10\Debuggers\inc\engextcpp.hpp",
          "C:\Program Files\Windows Kits\10\Debuggers\inc\engextcpp.hpp"
        )
        
        # Use pipeline to find the first existing path (avoids loop parser errors)
        $existing = $searchPaths | Where-Object { Test-Path $_ } | Select-Object -First 1
        
        if ($existing) {
          Write-Host "Debugging Tools found at: $(Split-Path -Parent $existing)"
          $debuggerFound = $true
        }
        
        if (-not $debuggerFound) {
          Write-Host "Debugging Tools not found. Installing latest Windows SDK..."
          
          # Download latest Windows 11 SDK web installer to ensure latest version
          $url = "https://go.microsoft.com/fwlink/?linkid=2196241"
          $setup = "$env:TEMP\winsdksetup.exe"
          
          Write-Host "Downloading SDK installer from $url..."
          Invoke-WebRequest -Uri $url -OutFile $setup -UseBasicParsing
          
          Write-Host "Installing Windows Debugging Tools..."
          # Install only the Debuggers feature using the official installer
          $process = Start-Process -FilePath $setup -ArgumentList "/features OptionId.WindowsDesktopDebuggers /q /norestart" -Wait -PassThru -NoNewWindow
          
          if ($process.ExitCode -ne 0) {
            Write-Host "SDK Installer failed with code $($process.ExitCode). Trying Chocolatey as fallback..."
            
            # Fallback: Chocolatey
            choco install windows-sdk-11 -y --no-progress
          }
          
          Write-Host "Installation completed."
        }
    
    - name: Detect SDK Paths and Setup Environment
      shell: powershell
      run: |
        Write-Host "Searching for Windows SDK Debuggers installation..."
        
        # Search for the SDK installation in common locations
        $searchPaths = @(
          "C:\Program Files (x86)\Windows Kits",
          "C:\Program Files\Windows Kits"
        )
        
        $incPath = ""
        $libPath = ""
        
        # Use pipeline to recursively search (avoids loop parser errors)
        $incFile = $searchPaths | Where-Object { Test-Path $_ } | ForEach-Object {
            Get-ChildItem -Path $_ -Filter "engextcpp.hpp" -Recurse -ErrorAction SilentlyContinue 
        } | Select-Object -First 1

        if ($incFile) {
            $incPath = Split-Path -Parent $incFile.FullName
            Write-Host "Found include path: $incPath"
        }
        
        if (-not $incPath) {
          Write-Host "ERROR: Could not find Windows SDK Debuggers include path (engextcpp.hpp)"
          Write-Host "Searched in:"
          $searchPaths | ForEach-Object { Write-Host "  - $_" }
          exit 1
        }
        
        # Find the corresponding lib\x64 path
        $debuggerRoot = Split-Path -Parent $incPath
        $libPath = Join-Path $debuggerRoot "lib\x64"
        
        if (-not (Test-Path $libPath)) {
          Write-Host "ERROR: Could not find library path at: $libPath"
          exit 1
        }
        
        Write-Host "Found library path: $libPath"
        
        # Export paths as environment variables for subsequent steps
        "WindowsSDKDebuggerIncPath=$incPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "WindowsSDKDebuggerLibPath=$libPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        Write-Host ""
        Write-Host "SDK paths configured successfully:"
        Write-Host "  Include: $incPath"
        Write-Host "  Library: $libPath"
    
    - name: Build Solution - ${{ matrix.configuration }}
      shell: powershell
      run: |
        Write-Host "Building ${{ matrix.configuration }} configuration for x64 platform..."
        Write-Host "Using SDK paths:"
        Write-Host "  Include: $env:WindowsSDKDebuggerIncPath"
        Write-Host "  Library: $env:WindowsSDKDebuggerLibPath"
        
        msbuild dk.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=x64 /p:PlatformToolset=v143 /p:WindowsSDKDebuggerIncPath="$env:WindowsSDKDebuggerIncPath" /p:WindowsSDKDebuggerLibPath="$env:WindowsSDKDebuggerLibPath" /v:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host "Build completed successfully."
    
    - name: Package Build Artifacts
      shell: powershell
      run: |
        $config = "${{ matrix.configuration }}"
        $buildPath = "x64\$config"
        
        # Create a release directory
        $releaseDir = "release-artifacts\$config"
        New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null
        
        # Copy DLL and PDB
        Copy-Item "$buildPath\dk.dll" -Destination $releaseDir
        Copy-Item "$buildPath\dk.pdb" -Destination $releaseDir
        
        # Create a zip file
        $zipName = "dk-${{ github.ref_name }}-$config-x64.zip"
        Compress-Archive -Path "$releaseDir\*" -DestinationPath $zipName
        
        Write-Host "Created release package: $zipName"
    
    - name: Upload artifacts for release job
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.configuration }}
        path: dk-${{ github.ref_name }}-${{ matrix.configuration }}-x64.zip

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure of downloaded files
      run: ls -R artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*.zip
        body: |
          # dk WinDbg Extension ${{ github.ref_name }}
          
          WinDbg extension for dumping memory data in meaningful and organized ways.
          
          ## Downloads
          
          - **Release Build (Recommended)**: `dk-${{ github.ref_name }}-Release-x64.zip`
          - **Debug Build**: `dk-${{ github.ref_name }}-Debug-x64.zip`
          
          ## Installation
          
          1. Download and extract the appropriate ZIP file
          2. Load the extension in WinDbg: `.load path\to\dk.dll`
          
          ## What's Changed
          
          See commit history for detailed changes in this release.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}