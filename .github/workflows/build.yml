name: Build

on:
  push:
    branches: [ main, master, working, fixsdk]  # Add your branch
  pull_request:
    branches: [ main, master, working, fixsdk]

jobs:
  build:
    runs-on: windows-latest
    
    permissions:
      contents: read
    
    strategy:
      matrix:
        configuration: [Debug, Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Install Windows SDK with Debugging Tools
      shell: powershell
      run: |
        Write-Host "Setting up Windows SDK and Debugging Tools..."
        
        # First, check what's already available
        Write-Host "`nChecking pre-installed SDKs..."
        $kitsPath = "C:\Program Files (x86)\Windows Kits\10\Include"
        if (Test-Path $kitsPath) {
          Get-ChildItem $kitsPath | ForEach-Object { Write-Host "  - $($_.Name)" }
        }
        
        # Check for Debugging Tools
        $debuggerFound = $false
        $searchPaths = @(
          "C:\Program Files (x86)\Windows Kits\10\Debuggers\inc\engextcpp.hpp",
          "C:\Program Files\Windows Kits\10\Debuggers\inc\engextcpp.hpp"
        )
        
        foreach ($path in $searchPaths) {
          if (Test-Path $path) {
            Write-Host "`n✓ Debugging Tools found at: $(Split-Path -Parent $path)"
            $debuggerFound = $true
            break
          }
        }
        
        if (-not $debuggerFound) {
          Write-Host "`nDebugging Tools not found. Installing via winget..."
          
          # Install using winget (cleanest method)
          winget install --id Microsoft.WindowsSDK.10.0.22621 `
            --silent `
            --accept-source-agreements `
            --accept-package-agreements `
            --scope machine
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "winget installation failed. Trying direct download..."
            
            # Fallback: Download standalone debuggers
            $url = "https://go.microsoft.com/fwlink/?linkid=2173743"
            $msi = "$env:TEMP\dbg_x64.msi"
            Invoke-WebRequest -Uri $url -OutFile $msi -UseBasicParsing
            Start-Process msiexec.exe -ArgumentList "/i", $msi, "/quiet", "/norestart" -Wait -NoNewWindow
          }
          
          Write-Host "`n✓ Installation completed."
        }
    
    - name: Detect SDK Paths and Setup Environment
      shell: powershell
      run: |
        Write-Host "Searching for Windows SDK Debuggers installation..."
        
        # Search for the SDK installation in common locations
        $searchPaths = @(
          "C:\Program Files (x86)\Windows Kits",
          "C:\Program Files\Windows Kits"
        )
        
        $incPath = ""
        $libPath = ""
        
        foreach ($searchPath in $searchPaths) {
          if (Test-Path $searchPath) {
            # Find engextcpp.hpp
            $incFiles = Get-ChildItem -Path $searchPath -Filter "engextcpp.hpp" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($incFiles) {
              $incPath = Split-Path -Parent $incFiles.FullName
              Write-Host "Found include path: $incPath"
              break
            }
          }
        }
        
        if (-not $incPath) {
          Write-Host "ERROR: Could not find Windows SDK Debuggers include path (engextcpp.hpp)"
          Write-Host "Searched in:"
          foreach ($sp in $searchPaths) {
            Write-Host "  - $sp"
          }
          exit 1
        }
        
        # Find the corresponding lib\x64 path
        $debuggerRoot = Split-Path -Parent $incPath
        $libPath = Join-Path $debuggerRoot "lib\x64"
        
        if (-not (Test-Path $libPath)) {
          Write-Host "ERROR: Could not find library path at: $libPath"
          exit 1
        }
        
        Write-Host "Found library path: $libPath"
        
        # Export paths as environment variables for subsequent steps
        "WindowsSDKDebuggerIncPath=$incPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "WindowsSDKDebuggerLibPath=$libPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        Write-Host ""
        Write-Host "SDK paths configured successfully:"
        Write-Host "  Include: $incPath"
        Write-Host "  Library: $libPath"
    
    - name: Build Solution - ${{ matrix.configuration }}
      shell: powershell
      run: |
        Write-Host "Building ${{ matrix.configuration }} configuration for x64 platform..."
        Write-Host "Using SDK paths:"
        Write-Host "  Include: $env:WindowsSDKDebuggerIncPath"
        Write-Host "  Library: $env:WindowsSDKDebuggerLibPath"
        
        msbuild dk.sln `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=x64 `
          /p:PlatformToolset=v143 `
          /p:WindowsSDKDebuggerIncPath="$env:WindowsSDKDebuggerIncPath" `
          /p:WindowsSDKDebuggerLibPath="$env:WindowsSDKDebuggerLibPath" `
          /m `
          /v:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host "Build completed successfully."
    
    - name: Verify Build Output
      shell: powershell
      run: |
        $buildPath = "x64\${{ matrix.configuration }}\dk.dll"
        if (Test-Path $buildPath) {
          Write-Host "✓ Build artifact found: $buildPath"
          $fileInfo = Get-Item $buildPath
          Write-Host "  Size: $($fileInfo.Length) bytes"
          Write-Host "  Created: $($fileInfo.CreationTime)"
        } else {
          Write-Host "✗ Build artifact not found at expected location: $buildPath"
          Write-Host ""
          Write-Host "Listing build output directories:"
          if (Test-Path "x64") {
            Get-ChildItem "x64" -Recurse | Select-Object FullName
          }
          exit 1
        }
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dk-${{ matrix.configuration }}-x64
        path: |
          x64/${{ matrix.configuration }}/dk.dll
          x64/${{ matrix.configuration }}/dk.pdb
        if-no-files-found: error
